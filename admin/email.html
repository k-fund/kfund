<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì´ë©”ì¼ ë°œì†¡ - K-ìê¸ˆì»´í¼ë‹ˆ</title>
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
  <script src="/js/admin-auth.js"></script>
  <style>
    /* ========================================
       Email Page Specific Styles
       ======================================== */
    .email-layout {
      display: grid;
      grid-template-columns: 320px 1fr 380px;
      gap: 20px;
      align-items: start;
    }

    .panel {
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--neutral-200);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .panel-header h3 {
      font-size: 15px;
      font-weight: 700;
      color: var(--neutral-800);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel-header .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }
    .badge-blue { background: var(--primary-light); color: var(--primary); }
    .badge-green { background: #D1FAE5; color: #059669; }

    .panel-body { padding: 20px; }

    /* [LEFT] Recipient List */
    .recipient-search {
      position: relative;
      margin-bottom: 12px;
    }
    .recipient-search input {
      width: 100%;
      padding: 10px 12px 10px 36px;
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }
    .recipient-search input:focus { border-color: var(--primary); }
    .recipient-search .search-icon {
      position: absolute;
      left: 10px; top: 50%;
      transform: translateY(-50%);
      color: var(--neutral-400);
    }

    .recipient-actions {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .btn-filter {
      padding: 4px 10px;
      font-size: 12px;
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-sm);
      background: white;
      cursor: pointer;
      font-family: inherit;
      color: var(--neutral-600);
      transition: all 0.15s;
    }
    .btn-filter:hover { background: var(--neutral-50); border-color: var(--neutral-300); }
    .btn-filter.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }

    .recipient-list {
      max-height: 480px;
      overflow-y: auto;
    }
    .recipient-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: background 0.15s;
    }
    .recipient-item:hover { background: var(--neutral-50); }
    .recipient-item.selected { background: var(--primary-light); }
    .recipient-item input[type="checkbox"] {
      width: 16px; height: 16px;
      accent-color: var(--primary);
      cursor: pointer;
      flex-shrink: 0;
    }
    .recipient-info { flex: 1; min-width: 0; }
    .recipient-name { font-size: 13px; font-weight: 600; color: var(--neutral-800); }
    .recipient-company { font-size: 12px; color: var(--neutral-500); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .recipient-email { font-size: 11px; color: var(--neutral-400); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .recipient-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .status-new { background: #DBEAFE; color: #1D4ED8; }
    .status-progress { background: #FEF3C7; color: #D97706; }
    .status-complete { background: #D1FAE5; color: #059669; }
    .status-cancel { background: #FEE2E2; color: #DC2626; }

    .selected-count {
      padding: 12px 16px;
      border-top: 1px solid var(--neutral-200);
      font-size: 12px;
      color: var(--neutral-500);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .selected-count strong { color: var(--primary); }

    .no-email-tag {
      font-size: 10px;
      color: var(--neutral-400);
      background: var(--neutral-100);
      padding: 1px 5px;
      border-radius: 3px;
    }

    .recipient-loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--neutral-400);
      font-size: 13px;
    }

    /* [CENTER] Template & Form */
    .template-selector { margin-bottom: 20px; }
    .template-selector > label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--neutral-700);
      margin-bottom: 6px;
    }
    .template-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .template-card {
      padding: 12px;
      border: 2px solid var(--neutral-200);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .template-card:hover { border-color: var(--neutral-300); }
    .template-card.active { border-color: var(--primary); background: var(--primary-light); }
    .template-card .icon { font-size: 24px; margin-bottom: 4px; }
    .template-card .label { font-size: 12px; font-weight: 600; color: var(--neutral-700); }
    .template-card .desc { font-size: 11px; color: var(--neutral-500); margin-top: 2px; }

    .form-divider {
      border: none;
      border-top: 1px solid var(--neutral-200);
      margin: 20px 0;
    }

    .email-form-group { margin-bottom: 16px; }
    .email-form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--neutral-700);
      margin-bottom: 6px;
    }
    .email-form-group label .required { color: var(--error); margin-left: 2px; }
    .email-form-group label .hint {
      font-weight: 400;
      font-size: 11px;
      color: var(--neutral-400);
      margin-left: 4px;
    }
    .email-form-group input,
    .email-form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-md);
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }
    .email-form-group input:focus,
    .email-form-group textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(29, 0, 173, 0.08);
    }
    .email-form-group textarea { resize: vertical; min-height: 80px; }

    .var-tag-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }
    .var-tag {
      font-size: 11px;
      padding: 3px 8px;
      background: var(--neutral-100);
      border: 1px solid var(--neutral-200);
      border-radius: 4px;
      color: var(--neutral-600);
      cursor: pointer;
      transition: all 0.15s;
      font-family: 'SF Mono', 'Fira Code', monospace;
    }
    .var-tag:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 24px;
    }
    .btn-send {
      flex: 1;
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
      background: var(--primary);
      color: white;
    }
    .btn-send:hover { background: var(--primary-dark); }
    .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Progress Bar */
    .send-progress {
      margin-top: 16px;
      display: none;
    }
    .send-progress.visible { display: block; }
    .progress-bar-bg {
      height: 6px;
      background: var(--neutral-200);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--primary);
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s ease;
    }
    .progress-text {
      font-size: 12px;
      color: var(--neutral-500);
      text-align: center;
    }

    /* Send Result Log */
    .send-log {
      margin-top: 12px;
      max-height: 160px;
      overflow-y: auto;
      font-size: 12px;
    }
    .send-log-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 0;
      color: var(--neutral-600);
    }
    .send-log-item.success { color: var(--success); }
    .send-log-item.fail { color: var(--error); }

    /* [RIGHT] Preview */
    .preview-toolbar {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }
    .preview-tab {
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid var(--neutral-200);
      border-radius: 20px;
      background: white;
      cursor: pointer;
      color: var(--neutral-500);
      transition: all 0.15s;
      font-family: inherit;
    }
    .preview-tab.active { background: var(--primary); color: white; border-color: var(--primary); }

    .email-preview-frame {
      border: 1px solid var(--neutral-200);
      border-radius: var(--radius-md);
      background: #F5F5F5;
      overflow: hidden;
    }

    .preview-meta {
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid var(--neutral-200);
      font-size: 12px;
    }
    .preview-meta-row {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
    }
    .preview-meta-row:last-child { margin-bottom: 0; }
    .meta-label {
      color: var(--neutral-400);
      width: 40px;
      flex-shrink: 0;
    }
    .meta-value { color: var(--neutral-700); font-weight: 500; }

    .preview-body {
      padding: 20px;
      max-height: 600px;
      overflow-y: auto;
    }

    /* Email Template Styles */
    .email-template {
      max-width: 340px;
      margin: 0 auto;
      font-family: 'Pretendard', -apple-system, sans-serif;
    }
    .email-template .et-header {
      background: linear-gradient(135deg, #0F1B2D 0%, #141414 100%);
      color: white;
      padding: 28px 24px;
      border-radius: 12px 12px 0 0;
      text-align: center;
    }
    .email-template .et-header h2 {
      font-size: 17px;
      font-weight: 700;
      margin: 12px 0 0;
    }
    .email-template .et-header p {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 6px;
    }
    .email-template .et-notice {
      background: #fef3c7;
      padding: 8px 16px;
      text-align: center;
      font-size: 11px;
      color: #92400e;
      line-height: 1.5;
      border-left: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
    }
    .email-template .et-body {
      background: white;
      padding: 24px 20px;
      border: 1px solid #e5e7eb;
      border-top: none;
    }
    .email-template .et-greeting {
      background: #F5F5F5;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      border-left: 3px solid #1C2D4F;
    }
    .email-template .et-greeting p {
      font-size: 13px;
      color: #404040;
      line-height: 1.7;
      margin: 0;
    }
    .email-template .et-greeting p + p { margin-top: 8px; }
    .email-template .et-greeting strong { color: #1C2D4F; }
    .email-template .et-info-box {
      background: linear-gradient(135deg, #0F1B2D 0%, #141414 100%);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .email-template .et-info-box h4 {
      color: white;
      font-size: 13px;
      margin: 0 0 10px 0;
    }
    .email-template .et-info-box table {
      width: 100%;
      font-size: 11px;
      border-collapse: separate;
      border-spacing: 0 4px;
    }
    .email-template .et-info-box td {
      padding: 6px 10px;
      color: white;
    }
    .email-template .et-info-box td:first-child {
      background: rgba(255,255,255,0.15);
      border-radius: 6px 0 0 6px;
      width: 35%;
      white-space: nowrap;
    }
    .email-template .et-info-box td:last-child {
      background: rgba(255,255,255,0.1);
      border-radius: 0 6px 6px 0;
      font-weight: 600;
    }
    .email-template .et-cta {
      background: #F5F5F5;
      padding: 14px;
      border-radius: 8px;
      border-left: 3px solid #1C2D4F;
      text-align: center;
      margin-bottom: 16px;
    }
    .email-template .et-cta p {
      font-size: 13px;
      color: #1C2D4F;
      font-weight: 600;
      line-height: 1.6;
      margin: 0;
    }
    .email-template .et-contact {
      text-align: center;
      padding: 14px 0;
      border-top: 1px dashed #e5e7eb;
      font-size: 12px;
      color: #6b7280;
    }
    .email-template .et-contact p { margin: 0; }
    .email-template .et-contact p + p { margin-top: 4px; }
    .email-template .et-contact strong { color: #374151; }
    .email-template .et-footer {
      background: #0F1B2D;
      border-radius: 0 0 12px 12px;
      padding: 14px;
      text-align: center;
      color: white;
    }
    .email-template .et-footer p { margin: 0; font-size: 11px; }
    .email-template .et-footer p + p { margin-top: 4px; }
    .email-template .et-footer .brand { font-weight: 700; font-size: 13px; }

    .var-highlight {
      background: #FEF3C7;
      color: #92400e;
      padding: 1px 4px;
      border-radius: 3px;
      font-weight: 600;
      font-size: inherit;
    }

    /* Custom template body editor */
    .custom-body-editor {
      display: none;
    }
    .custom-body-editor.visible { display: block; }

    /* Toast */
    .toast {
      position: fixed;
      top: 24px;
      right: 24px;
      padding: 14px 20px;
      border-radius: var(--radius-md);
      color: white;
      font-size: 14px;
      font-weight: 500;
      z-index: 10000;
      transform: translateX(120%);
      transition: transform 0.3s ease;
      box-shadow: var(--shadow-lg);
    }
    .toast.show { transform: translateX(0); }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--error); }
    .toast.info { background: var(--primary); }

    /* Responsive */
    @media (max-width: 1280px) {
      .email-layout {
        grid-template-columns: 280px 1fr;
      }
      .preview-panel { grid-column: 1 / -1; }
    }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0; }
      .email-layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <!-- ì‚¬ì´ë“œë°” ì˜¤ë²„ë ˆì´ (ëª¨ë°”ì¼) -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1 class="logo">K-ìê¸ˆì»´í¼ë‹ˆ</h1>
        <span class="logo-sub">ê´€ë¦¬ì</span>
      </div>

      <nav class="sidebar-nav">
        <a href="/admin/" class="nav-item">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
            </svg>
          </span>
          <span class="nav-text">ëŒ€ì‹œë³´ë“œ</span>
        </a>
        <a href="/admin/leads.html" class="nav-item">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/>
              <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/>
            </svg>
          </span>
          <span class="nav-text">ì ‘ìˆ˜ë‚´ì—­</span>
        </a>
        <a href="/admin/email.html" class="nav-item active">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
              <polyline points="22,6 12,13 2,6"/>
            </svg>
          </span>
          <span class="nav-text">ì´ë©”ì¼ ë°œì†¡</span>
        </a>
        <a href="/admin/board.html" class="nav-item">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
          </span>
          <span class="nav-text">ê²Œì‹œíŒ ê´€ë¦¬</span>
        </a>
        <a href="/admin/employees.html" class="nav-item">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
          </span>
          <span class="nav-text">ì„ì§ì› ê´€ë¦¬</span>
        </a>
        <a href="/admin/popups.html" class="nav-item">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
          </span>
          <span class="nav-text">íŒì—… ê´€ë¦¬</span>
        </a>
        <a href="/admin/analytics.html" class="nav-item">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"/>
              <line x1="12" y1="20" x2="12" y2="4"/>
              <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
          </span>
          <span class="nav-text">ë°©ë¬¸í†µê³„</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <a href="https://k-fund.kr" class="nav-item" target="_blank">
          <span class="nav-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
          </span>
          <span class="nav-text">ì‚¬ì´íŠ¸ ë³´ê¸°</span>
        </a>
      </div>
    </aside>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content">
      <!-- í—¤ë” -->
      <header class="dashboard-header">
        <div class="header-left">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="12" x2="21" y2="12"/>
              <line x1="3" y1="6" x2="21" y2="6"/>
              <line x1="3" y1="18" x2="21" y2="18"/>
            </svg>
          </button>
          <div>
            <h1 class="page-title">ì´ë©”ì¼ ë°œì†¡</h1>
            <p class="page-subtitle">ì ‘ìˆ˜ ê³ ê°ì—ê²Œ ë§ì¶¤ ì´ë©”ì¼ì„ ë°œì†¡í•˜ì„¸ìš”</p>
          </div>
        </div>
        <div class="header-right">
          <span class="user-name">ê´€ë¦¬ì</span>
          <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </header>

      <!-- 3-Column Email Layout -->
      <div class="email-layout">

        <!-- [LEFT] ìˆ˜ì‹ ì ëª©ë¡ -->
        <div class="panel">
          <div class="panel-header">
            <h3>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              ìˆ˜ì‹ ì ì„ íƒ
            </h3>
            <span class="badge badge-blue" id="totalBadge">0ê±´</span>
          </div>
          <div class="panel-body">
            <div class="recipient-search">
              <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              <input type="text" id="recipientSearch" placeholder="ì´ë¦„, ê¸°ì—…ëª…, ì´ë©”ì¼ ê²€ìƒ‰..." oninput="filterRecipients()">
            </div>

            <div class="recipient-actions">
              <button class="btn-filter active" data-filter="all" onclick="setFilter(this)">ì „ì²´</button>
              <button class="btn-filter" data-filter="pending" onclick="setFilter(this)">ì‹ ê·œ</button>
              <button class="btn-filter" data-filter="progress" onclick="setFilter(this)">ìƒë‹´ì¤‘</button>
              <button class="btn-filter" data-filter="email-only" onclick="setFilter(this)">ì´ë©”ì¼ ìˆëŠ” ê±´ë§Œ</button>
            </div>

            <div class="recipient-list" id="recipientList">
              <div class="recipient-loading">ìˆ˜ì‹ ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
          </div>
          <div class="selected-count">
            <span>ì„ íƒ <strong id="selectedCount">0</strong> / <span id="totalRecipients">0</span> ëª…</span>
            <button class="btn-filter" onclick="toggleSelectAll()" id="btnSelectAll">ì „ì²´ ì„ íƒ</button>
          </div>
        </div>

        <!-- [CENTER] ë©”ì¼ ì‘ì„± -->
        <div class="panel">
          <div class="panel-header">
            <h3>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              ë©”ì¼ ì‘ì„±
            </h3>
          </div>
          <div class="panel-body">
            <!-- í…œí”Œë¦¿ ì„ íƒ -->
            <div class="template-selector">
              <label>í…œí”Œë¦¿ ì„ íƒ</label>
              <div class="template-cards">
                <div class="template-card active" data-template="receipt" onclick="selectTemplate(this)">
                  <div class="icon">ğŸ“‹</div>
                  <div class="label">ì ‘ìˆ˜ í™•ì¸</div>
                  <div class="desc">ìƒë‹´ì‹ ì²­ ì ‘ìˆ˜ ì•ˆë‚´</div>
                </div>
                <div class="template-card" data-template="progress" onclick="selectTemplate(this)">
                  <div class="icon">ğŸ“Š</div>
                  <div class="label">ì§„í–‰ ì•ˆë‚´</div>
                  <div class="desc">ì‹¬ì‚¬ ì§„í–‰ìƒí™© ì•ˆë‚´</div>
                </div>
                <div class="template-card" data-template="approval" onclick="selectTemplate(this)">
                  <div class="icon">ğŸ‰</div>
                  <div class="label">ìŠ¹ì¸ ì¶•í•˜</div>
                  <div class="desc">ìê¸ˆ ìŠ¹ì¸ ì•ˆë‚´</div>
                </div>
                <div class="template-card" data-template="custom" onclick="selectTemplate(this)">
                  <div class="icon">âœ‰ï¸</div>
                  <div class="label">ì§ì ‘ ì‘ì„±</div>
                  <div class="desc">ììœ  í˜•ì‹ ë©”ì¼</div>
                </div>
              </div>
            </div>

            <hr class="form-divider">

            <!-- ê³µí†µ í•„ë“œ -->
            <div class="email-form-group">
              <label>ë³´ë‚´ëŠ” ì´ë¦„ <span class="required">*</span></label>
              <input type="text" id="senderName" value="K-ìê¸ˆì»´í¼ë‹ˆ" placeholder="ë°œì‹ ì í‘œì‹œëª…" oninput="updatePreview()">
            </div>

            <div class="email-form-group">
              <label>ì œëª© <span class="required">*</span></label>
              <input type="text" id="emailSubject" value="[K-ìê¸ˆì»´í¼ë‹ˆ] ë¬´ë£Œì§„ë‹¨ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤" placeholder="ì´ë©”ì¼ ì œëª©" oninput="updatePreview()">
            </div>

            <hr class="form-divider">

            <div class="email-form-group">
              <label>ë‹´ë‹¹ìëª… <span class="hint">(ë³¸ë¬¸ ì‚½ì…)</span></label>
              <input type="text" id="staffName" value="ê¹€ì€í¬ ê¸°ì—…ì‹¬ì‚¬ê´€" placeholder="ë‹´ë‹¹ìëª…" oninput="updatePreview()">
            </div>

            <div class="email-form-group">
              <label>íšŒì‹  ë§ˆê°ì¼ <span class="hint">(ì„ íƒ)</span></label>
              <input type="date" id="deadline" oninput="updatePreview()">
            </div>

            <div class="email-form-group">
              <label>ì¶”ê°€ ë©”ì‹œì§€ <span class="hint">(ì„ íƒ)</span></label>
              <textarea id="extraMessage" placeholder="ì´ë©”ì¼ í•˜ë‹¨ì— ì¶”ê°€í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." oninput="updatePreview()"></textarea>
            </div>

            <!-- ì§ì ‘ì‘ì„± ì „ìš©: ë³¸ë¬¸ ì—ë””í„° -->
            <div class="custom-body-editor" id="customBodyEditor">
              <div class="email-form-group">
                <label>ë³¸ë¬¸ ë‚´ìš© <span class="required">*</span></label>
                <textarea id="customBody" rows="8" placeholder="ì´ë©”ì¼ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”. {{ê³ ê°ëª…}}, {{ê¸°ì—…ëª…}} ë“±ì˜ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." oninput="updatePreview()"></textarea>
              </div>
            </div>

            <!-- ë³€ìˆ˜ íƒœê·¸ -->
            <div>
              <label style="font-size:12px; color:var(--neutral-500); margin-bottom:4px; display:block;">í´ë¦­í•˜ë©´ ì œëª©/ë³¸ë¬¸ì— ì‚½ì…ë©ë‹ˆë‹¤</label>
              <div class="var-tag-row">
                <span class="var-tag" onclick="insertVariable('{{ê³ ê°ëª…}}')">{{ê³ ê°ëª…}}</span>
                <span class="var-tag" onclick="insertVariable('{{ê¸°ì—…ëª…}}')">{{ê¸°ì—…ëª…}}</span>
                <span class="var-tag" onclick="insertVariable('{{ìê¸ˆì¢…ë¥˜}}')">{{ìê¸ˆì¢…ë¥˜}}</span>
                <span class="var-tag" onclick="insertVariable('{{í¬ë§ê¸ˆì•¡}}')">{{í¬ë§ê¸ˆì•¡}}</span>
                <span class="var-tag" onclick="insertVariable('{{ì ‘ìˆ˜ì¼}}')">{{ì ‘ìˆ˜ì¼}}</span>
                <span class="var-tag" onclick="insertVariable('{{ë‹´ë‹¹ì}}')">{{ë‹´ë‹¹ì}}</span>
              </div>
            </div>

            <!-- ë°œì†¡ ë²„íŠ¼ -->
            <div class="form-actions">
              <button class="btn-secondary" onclick="updatePreview()" style="padding:10px 20px; border:1px solid var(--neutral-200); border-radius:var(--radius-md); background:white; cursor:pointer; font-family:inherit; font-size:14px;">ë¯¸ë¦¬ë³´ê¸°</button>
              <button class="btn-send" id="btnSend" onclick="sendEmails()" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                <span id="btnSendText">ìˆ˜ì‹ ìë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
              </button>
            </div>

            <!-- ë°œì†¡ ì§„í–‰ë°” -->
            <div class="send-progress" id="sendProgress">
              <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressFill"></div>
              </div>
              <div class="progress-text" id="progressText">0 / 0 ê±´ ë°œì†¡ ì¤‘...</div>
            </div>

            <!-- ë°œì†¡ ê²°ê³¼ ë¡œê·¸ -->
            <div class="send-log" id="sendLog"></div>
          </div>
        </div>

        <!-- [RIGHT] ë¯¸ë¦¬ë³´ê¸° -->
        <div class="panel preview-panel">
          <div class="panel-header">
            <h3>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              ë¯¸ë¦¬ë³´ê¸°
            </h3>
            <span class="badge badge-green">ì‹¤ì‹œê°„</span>
          </div>
          <div class="panel-body">
            <div class="preview-toolbar">
              <button class="preview-tab active" data-tab="customer" onclick="switchPreviewTab(this)">ê³ ê°ìš©</button>
              <button class="preview-tab" data-tab="staff" onclick="switchPreviewTab(this)">ë‹´ë‹¹ììš©</button>
            </div>

            <div class="email-preview-frame">
              <div class="preview-meta" id="previewMeta">
                <div class="preview-meta-row">
                  <span class="meta-label">From</span>
                  <span class="meta-value" id="metaFrom">K-ìê¸ˆì»´í¼ë‹ˆ &lt;noreply@mail.policy-fund.online&gt;</span>
                </div>
                <div class="preview-meta-row">
                  <span class="meta-label">To</span>
                  <span class="meta-value" id="metaTo">ìˆ˜ì‹ ìë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                </div>
                <div class="preview-meta-row">
                  <span class="meta-label">ì œëª©</span>
                  <span class="meta-value" id="metaSubject">[K-ìê¸ˆì»´í¼ë‹ˆ] ë¬´ë£Œì§„ë‹¨ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</span>
                </div>
              </div>

              <div class="preview-body" id="previewBody">
                <div class="email-template" id="emailPreviewContent">
                  <!-- Preview will be rendered here by JS -->
                </div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /email-layout -->
    </main>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ========================================
    // State
    // ========================================
    const API_URL = WORKER_URL; // admin-auth.jsì—ì„œ ì •ì˜
    let allLeads = [];
    let filteredLeadsList = [];
    let selectedIds = new Set();
    let currentFilter = 'all';
    let currentTemplate = 'receipt';
    let currentPreviewTab = 'customer';
    let isSending = false;
    let lastFocusedInput = null;

    // ë§ˆì§€ë§‰ í¬ì»¤ìŠ¤ëœ input ì¶”ì 
    document.addEventListener('focusin', (e) => {
      if (e.target.matches('#emailSubject, #extraMessage, #customBody')) {
        lastFocusedInput = e.target;
      }
    });

    // ========================================
    // Sidebar Toggle
    // ========================================
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
      document.querySelector('.sidebar-overlay').classList.toggle('open');
    }

    // ========================================
    // Toast
    // ========================================
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type;
      requestAnimationFrame(() => toast.classList.add('show'));
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ========================================
    // Load Leads
    // ========================================
    async function loadLeads() {
      try {
        const response = await fetch(`${API_URL}/leads`);
        const data = await response.json();

        if (data.success && data.leads) {
          allLeads = data.leads.map(lead => ({
            id: lead.id,
            date: lead.Date || (lead.createdTime ? lead.createdTime.split('T')[0] : '-'),
            company: lead.Company || '-',
            name: lead.Name || '-',
            phone: lead.Phone || '-',
            email: lead.Email || '',
            region: lead.Region || '-',
            amount: lead.Amount || '-',
            fundType: lead.FundType || '-',
            callTime: lead.CallTime || '-',
            status: mapStatus(lead.Status),
            statusLabel: lead.Status || 'ì‹ ê·œ',
            message: lead.Message || ''
          }));
        } else {
          allLeads = [];
        }
      } catch (error) {
        console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
        allLeads = [];
        showToast('ìˆ˜ì‹ ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', 'error');
      }

      filterRecipients();
      document.getElementById('totalBadge').textContent = allLeads.length + 'ê±´';
    }

    function mapStatus(status) {
      const map = { 'ì‹ ê·œ': 'pending', 'ìƒë‹´ì¤‘': 'progress', 'ì™„ë£Œ': 'complete', 'ì·¨ì†Œ': 'cancel' };
      return map[status] || 'pending';
    }

    // ========================================
    // Filter & Search Recipients
    // ========================================
    function setFilter(btn) {
      document.querySelectorAll('.recipient-actions .btn-filter').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      filterRecipients();
    }

    function filterRecipients() {
      const keyword = (document.getElementById('recipientSearch').value || '').toLowerCase();

      filteredLeadsList = allLeads.filter(lead => {
        // Status filter
        if (currentFilter === 'email-only' && !lead.email) return false;
        if (currentFilter === 'pending' && lead.status !== 'pending') return false;
        if (currentFilter === 'progress' && lead.status !== 'progress') return false;

        // Search filter
        if (keyword) {
          return lead.name.toLowerCase().includes(keyword) ||
                 lead.company.toLowerCase().includes(keyword) ||
                 (lead.email && lead.email.toLowerCase().includes(keyword));
        }
        return true;
      });

      renderRecipients();
    }

    function renderRecipients() {
      const container = document.getElementById('recipientList');
      document.getElementById('totalRecipients').textContent = filteredLeadsList.length;

      if (filteredLeadsList.length === 0) {
        container.innerHTML = '<div class="recipient-loading">í•´ë‹¹í•˜ëŠ” ìˆ˜ì‹ ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      container.innerHTML = filteredLeadsList.map(lead => {
        const hasEmail = lead.email && lead.email !== '-' && lead.email.includes('@');
        const isSelected = selectedIds.has(lead.id);
        const statusClass = {
          'pending': 'status-new',
          'progress': 'status-progress',
          'complete': 'status-complete',
          'cancel': 'status-cancel'
        }[lead.status] || 'status-new';
        const statusText = {
          'pending': 'ì‹ ê·œ',
          'progress': 'ìƒë‹´ì¤‘',
          'complete': 'ì™„ë£Œ',
          'cancel': 'ì·¨ì†Œ'
        }[lead.status] || 'ì‹ ê·œ';

        return `
          <label class="recipient-item ${isSelected ? 'selected' : ''}" data-id="${lead.id}">
            <input type="checkbox" ${isSelected ? 'checked' : ''} ${!hasEmail ? 'disabled' : ''} onchange="toggleRecipient('${lead.id}', this.checked)">
            <div class="recipient-info">
              <div class="recipient-name">${escapeHtml(lead.name)}</div>
              <div class="recipient-company">${escapeHtml(lead.company)}</div>
              <div class="recipient-email">${hasEmail ? escapeHtml(lead.email) : '<span class="no-email-tag">ì´ë©”ì¼ ì—†ìŒ</span>'}</div>
            </div>
            <span class="recipient-status ${statusClass}">${statusText}</span>
          </label>
        `;
      }).join('');

      updateSelectedCount();
    }

    function toggleRecipient(id, checked) {
      if (checked) {
        selectedIds.add(id);
      } else {
        selectedIds.delete(id);
      }
      // Update UI
      const item = document.querySelector(`.recipient-item[data-id="${id}"]`);
      if (item) item.classList.toggle('selected', checked);
      updateSelectedCount();
      updatePreview();
    }

    function toggleSelectAll() {
      const emailLeads = filteredLeadsList.filter(l => l.email && l.email !== '-' && l.email.includes('@'));
      const allSelected = emailLeads.every(l => selectedIds.has(l.id));

      if (allSelected) {
        emailLeads.forEach(l => selectedIds.delete(l.id));
      } else {
        emailLeads.forEach(l => selectedIds.add(l.id));
      }

      renderRecipients();
      updatePreview();
    }

    function updateSelectedCount() {
      const count = selectedIds.size;
      document.getElementById('selectedCount').textContent = count;

      const btn = document.getElementById('btnSend');
      const btnText = document.getElementById('btnSendText');
      if (count > 0) {
        btn.disabled = false;
        btnText.textContent = `${count}ëª…ì—ê²Œ ë°œì†¡`;
      } else {
        btn.disabled = true;
        btnText.textContent = 'ìˆ˜ì‹ ìë¥¼ ì„ íƒí•˜ì„¸ìš”';
      }

      // Toggle select all button text
      const emailLeads = filteredLeadsList.filter(l => l.email && l.email !== '-' && l.email.includes('@'));
      const allSelected = emailLeads.length > 0 && emailLeads.every(l => selectedIds.has(l.id));
      document.getElementById('btnSelectAll').textContent = allSelected ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ';
    }

    // ========================================
    // Template Selection
    // ========================================
    function selectTemplate(card) {
      document.querySelectorAll('.template-card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      currentTemplate = card.dataset.template;

      // Update subject based on template
      const subjectMap = {
        'receipt': '[K-ìê¸ˆì»´í¼ë‹ˆ] ë¬´ë£Œì§„ë‹¨ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤',
        'progress': '[K-ìê¸ˆì»´í¼ë‹ˆ] ì •ì±…ìê¸ˆ ì‹¬ì‚¬ ì§„í–‰ì•ˆë‚´',
        'approval': '[K-ìê¸ˆì»´í¼ë‹ˆ] ì •ì±…ìê¸ˆ ìŠ¹ì¸ ì•ˆë‚´',
        'custom': '[K-ìê¸ˆì»´í¼ë‹ˆ] '
      };
      document.getElementById('emailSubject').value = subjectMap[currentTemplate] || '';

      // Show/hide custom body editor
      const customEditor = document.getElementById('customBodyEditor');
      if (currentTemplate === 'custom') {
        customEditor.classList.add('visible');
      } else {
        customEditor.classList.remove('visible');
      }

      updatePreview();
    }

    // ========================================
    // Variable Insertion
    // ========================================
    function insertVariable(varTag) {
      const target = lastFocusedInput || document.getElementById('emailSubject');
      const pos = target.selectionStart || target.value.length;
      const val = target.value;
      target.value = val.slice(0, pos) + varTag + val.slice(pos);
      target.focus();
      target.setSelectionRange(pos + varTag.length, pos + varTag.length);
      updatePreview();
    }

    // ========================================
    // Email Templates
    // ========================================
    function getTemplateSubject(lead) {
      let subject = document.getElementById('emailSubject').value;
      return substituteVars(subject, lead);
    }

    function substituteVars(text, lead) {
      const staffName = document.getElementById('staffName').value || 'ê¹€ì€í¬ ê¸°ì—…ì‹¬ì‚¬ê´€';
      return text
        .replace(/\{\{ê³ ê°ëª…\}\}/g, lead.name || '-')
        .replace(/\{\{ê¸°ì—…ëª…\}\}/g, lead.company || '-')
        .replace(/\{\{ìê¸ˆì¢…ë¥˜\}\}/g, lead.fundType || '-')
        .replace(/\{\{í¬ë§ê¸ˆì•¡\}\}/g, lead.amount || '-')
        .replace(/\{\{ì ‘ìˆ˜ì¼\}\}/g, lead.date || '-')
        .replace(/\{\{ë‹´ë‹¹ì\}\}/g, staffName)
        .replace(/\{\{ì—°ë½ì²˜\}\}/g, lead.phone || '-')
        .replace(/\{\{ì´ë©”ì¼\}\}/g, lead.email || '-');
    }

    function highlightVars(text) {
      return text.replace(/\{\{([^}]+)\}\}/g, '<span class="var-highlight">{{$1}}</span>');
    }

    function buildCustomerEmailHTML(lead) {
      const staffName = document.getElementById('staffName').value || 'ê¹€ì€í¬ ê¸°ì—…ì‹¬ì‚¬ê´€';
      const deadline = document.getElementById('deadline').value;
      const extraMsg = document.getElementById('extraMessage').value;
      const subject = getTemplateSubject(lead);

      if (currentTemplate === 'custom') {
        return buildCustomEmailHTML(lead);
      }

      const greetings = {
        'receipt': `ì•ˆë…•í•˜ì„¸ìš”, <strong>${e(lead.name)}</strong>ë‹˜!<br><br>ì •ì±…ìê¸ˆ ì‹¬ì‚¬ì‹ ì²­ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>ì˜ì—…ì¼ê¸°ì¤€ 24ì‹œê°„ ì´ë‚´ ë‹´ë‹¹ ì „ë¬¸ ì»¨ì„¤í„´íŠ¸ê°€ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`,
        'progress': `ì•ˆë…•í•˜ì„¸ìš”, <strong>${e(lead.name)}</strong>ë‹˜!<br><br>ì‹ ì²­í•˜ì‹  ì •ì±…ìê¸ˆ ì‹¬ì‚¬ê°€ í˜„ì¬ <strong>ì§„í–‰ ì¤‘</strong>ì…ë‹ˆë‹¤.<br><br>ë‹´ë‹¹ ì‹¬ì‚¬ê´€ì´ ê²€í†  í›„ ê²°ê³¼ë¥¼ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`,
        'approval': `ì•ˆë…•í•˜ì„¸ìš”, <strong>${e(lead.name)}</strong>ë‹˜!<br><br>ì¶•í•˜í•©ë‹ˆë‹¤! ì‹ ì²­í•˜ì‹  ì •ì±…ìê¸ˆì´ <strong>ìŠ¹ì¸</strong>ë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ì‹œê³ , ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ë‹´ë‹¹ìì—ê²Œ ì—°ë½ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`
      };

      const ctaMessages = {
        'receipt': `ì˜ì—…ì¼ê¸°ì¤€ <strong>24ì‹œê°„ ì´ë‚´</strong>ì—<br>K-ìê¸ˆì»´í¼ë‹ˆì—ì„œ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`,
        'progress': `ì‹¬ì‚¬ ì§„í–‰ ì¤‘ ì¶”ê°€ ì„œë¥˜ê°€ í•„ìš”í•œ ê²½ìš°<br><strong>ë‹´ë‹¹ìê°€ ë³„ë„ ì•ˆë‚´</strong>ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`,
        'approval': `<strong>ì¶•í•˜í•©ë‹ˆë‹¤!</strong><br>ìì„¸í•œ ë‚´ìš©ì€ ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.`
      };

      const headerTitles = {
        'receipt': 'ë¬´ë£Œì§„ë‹¨ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤',
        'progress': 'ì •ì±…ìê¸ˆ ì‹¬ì‚¬ ì§„í–‰ì•ˆë‚´',
        'approval': 'ì •ì±…ìê¸ˆ ìŠ¹ì¸ì„ ì¶•í•˜í•©ë‹ˆë‹¤!'
      };

      let extraSection = '';
      if (extraMsg) {
        extraSection = `
          <div style="background:#F5F5F5; padding:16px; border-radius:8px; margin-bottom:16px; border-left:3px solid #1C2D4F;">
            <p style="font-size:13px; color:#404040; line-height:1.7; margin:0;">${e(extraMsg).replace(/\n/g, '<br>')}</p>
          </div>`;
      }

      return buildEmailFrame(
        headerTitles[currentTemplate],
        greetings[currentTemplate],
        lead,
        deadline,
        ctaMessages[currentTemplate],
        extraSection,
        staffName
      );
    }

    function buildCustomEmailHTML(lead) {
      const customBody = document.getElementById('customBody').value;
      const staffName = document.getElementById('staffName').value || 'ê¹€ì€í¬ ê¸°ì—…ì‹¬ì‚¬ê´€';
      const subject = document.getElementById('emailSubject').value;
      const bodyHtml = substituteVars(customBody, lead).replace(/\n/g, '<br>');

      return `
      <div style="font-family:'Pretendard',-apple-system,sans-serif; max-width:600px; margin:0 auto;">
        <div style="background:linear-gradient(135deg,#0F1B2D 0%,#141414 100%); color:white; padding:35px 30px; border-radius:16px 16px 0 0; text-align:center;">
          <img src="https://pub-d4f7fa5a4cb648d48f34274fcba1d283.r2.dev/logo_light.png" alt="K-ìê¸ˆì»´í¼ë‹ˆ" style="width:120px; height:auto; margin-bottom:15px;">
          <h2 style="margin:0; font-size:22px; font-weight:700;">${e(substituteVars(subject, lead))}</h2>
          <p style="margin:12px 0 0; opacity:0.95; font-size:14px;">K-ìê¸ˆì»´í¼ë‹ˆ ì •ì±…ìê¸ˆ ì „ë¬¸ìƒë‹´</p>
        </div>
        <div style="background:#fef3c7; padding:12px 20px; text-align:center; border-left:1px solid #e5e7eb; border-right:1px solid #e5e7eb;">
          <p style="margin:0; color:#92400e; font-size:12px; line-height:1.6;">ğŸ“§ ë³¸ ë©”ì¼ì€ ë°œì‹ ì „ìš©ìœ¼ë¡œ íšŒì‹ ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.<br>ë¬¸ì˜ëŠ” <strong>1844-0239</strong> ë˜ëŠ” <strong>ni5720@daum.net</strong>ìœ¼ë¡œ ì—°ë½ì£¼ì„¸ìš”.</p>
        </div>
        <div style="background:white; padding:35px 30px; border:1px solid #e5e7eb; border-top:none;">
          <div style="font-size:14px; color:#404040; line-height:1.8;">${bodyHtml}</div>
          <div style="text-align:center; padding:20px 0; margin-top:20px; border-top:1px dashed #e5e7eb;">
            <p style="margin:0 0 15px; color:#6b7280; font-size:13px;">ë¬¸ì˜ì‚¬í•­ì€ ì•„ë˜ ì—°ë½ì²˜ë¡œ ì—°ë½ì£¼ì„¸ìš”</p>
            <p style="margin:0 0 6px; color:#374151; font-size:13px;">ğŸ“ <strong>1844-0239</strong></p>
            <p style="margin:0; color:#374151; font-size:13px;">âœ‰ï¸ <strong>ni5720@daum.net</strong></p>
          </div>
        </div>
        <div style="text-align:center; padding:20px 12px; background:#0F1B2D; border-radius:0 0 16px 16px; color:white;">
          <p style="margin:0 0 6px; font-weight:700; font-size:14px;">K-ìê¸ˆì»´í¼ë‹ˆ</p>
          <p style="margin:0 0 4px; opacity:0.85; font-size:12px;">ì¤‘ì†Œê¸°ì—… ì„±ì¥ì˜ ë“ ë“ í•œ íŒŒíŠ¸ë„ˆ</p>
          <p style="margin:10px 0 0; opacity:0.7; font-size:10px;">â€» ë³¸ ë©”ì¼ì€ ë°œì‹ ì „ìš©ìœ¼ë¡œ íšŒì‹ ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</p>
          <p style="margin:4px 0 0; opacity:0.7; font-size:10px;">ë¬¸ì˜: 1844-0239 | ni5720@daum.net</p>
        </div>
      </div>`;
    }

    function buildEmailFrame(headerTitle, greeting, lead, deadline, ctaMessage, extraSection, staffName) {
      return `
      <div style="font-family:'Pretendard',-apple-system,sans-serif; max-width:600px; margin:0 auto;">
        <div style="background:linear-gradient(135deg,#0F1B2D 0%,#141414 100%); color:white; padding:35px 30px; border-radius:16px 16px 0 0; text-align:center;">
          <img src="https://pub-d4f7fa5a4cb648d48f34274fcba1d283.r2.dev/logo_light.png" alt="K-ìê¸ˆì»´í¼ë‹ˆ" style="width:120px; height:auto; margin-bottom:15px;">
          <h2 style="margin:0; font-size:22px; font-weight:700;">${e(headerTitle)}</h2>
          <p style="margin:12px 0 0; opacity:0.95; font-size:14px;">K-ìê¸ˆì»´í¼ë‹ˆ ì •ì±…ìê¸ˆ ì „ë¬¸ìƒë‹´</p>
        </div>
        <div style="background:#fef3c7; padding:12px 20px; text-align:center; border-left:1px solid #e5e7eb; border-right:1px solid #e5e7eb;">
          <p style="margin:0; color:#92400e; font-size:12px; line-height:1.6;">ğŸ“§ ë³¸ ë©”ì¼ì€ ë°œì‹ ì „ìš©ìœ¼ë¡œ íšŒì‹ ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.<br>ë¬¸ì˜ëŠ” <strong>1844-0239</strong> ë˜ëŠ” <strong>ni5720@daum.net</strong>ìœ¼ë¡œ ì—°ë½ì£¼ì„¸ìš”.</p>
        </div>
        <div style="background:white; padding:35px 30px; border:1px solid #e5e7eb; border-top:none;">
          <div style="background:#F5F5F5; padding:24px; border-radius:12px; margin-bottom:25px; border-left:4px solid #1C2D4F;">
            <p style="margin:0; color:#404040; line-height:1.8; font-size:14px;">${greeting}</p>
          </div>
          <div style="background:linear-gradient(135deg,#0F1B2D 0%,#141414 100%); padding:24px; border-radius:12px; margin-bottom:25px; box-shadow:0 4px 15px rgba(0,0,0,0.25);">
            <h3 style="color:white; margin:0 0 18px; font-size:16px; font-weight:600;">ğŸ“‹ ì ‘ìˆ˜ ë‚´ìš©</h3>
            <table style="width:100%; color:white; font-size:12px; border-collapse:separate; border-spacing:0 6px;">
              <tr><td style="padding:8px 12px; background:rgba(255,255,255,0.15); border-radius:8px 0 0 8px; width:35%; white-space:nowrap;">ğŸ¢ ê¸°ì—…ëª…</td><td style="padding:8px 12px; background:rgba(255,255,255,0.1); border-radius:0 8px 8px 0; font-weight:600;">${e(lead.company)}</td></tr>
              <tr><td style="padding:8px 12px; background:rgba(255,255,255,0.15); border-radius:8px 0 0 8px; white-space:nowrap;">ğŸ“ ì—°ë½ì²˜</td><td style="padding:8px 12px; background:rgba(255,255,255,0.1); border-radius:0 8px 8px 0; font-weight:600;">${e(lead.phone)}</td></tr>
              <tr><td style="padding:8px 12px; background:rgba(255,255,255,0.15); border-radius:8px 0 0 8px; white-space:nowrap;">ğŸ’° í¬ë§ìê¸ˆ</td><td style="padding:8px 12px; background:rgba(255,255,255,0.1); border-radius:0 8px 8px 0; font-weight:600;">${e(lead.amount)}</td></tr>
              <tr><td style="padding:8px 12px; background:rgba(255,255,255,0.15); border-radius:8px 0 0 8px; white-space:nowrap;">â° ì—°ë½ì‹œê°„</td><td style="padding:8px 12px; background:rgba(255,255,255,0.1); border-radius:0 8px 8px 0; font-weight:600;">${e(lead.callTime)}</td></tr>
              ${deadline ? `<tr><td style="padding:8px 12px; background:rgba(255,255,255,0.15); border-radius:8px 0 0 8px; white-space:nowrap;">ğŸ“… ë§ˆê°ì¼</td><td style="padding:8px 12px; background:rgba(255,255,255,0.1); border-radius:0 8px 8px 0; font-weight:600;">${e(deadline)}</td></tr>` : ''}
            </table>
          </div>
          ${extraSection}
          <div style="background:#F5F5F5; padding:20px 24px; border-radius:12px; margin-bottom:25px; border-left:4px solid #1C2D4F; text-align:center;">
            <p style="margin:0; color:#1C2D4F; font-weight:600; font-size:15px; line-height:1.7;">${ctaMessage}</p>
          </div>
          <div style="text-align:center; padding:20px 0; border-top:1px dashed #e5e7eb;">
            <p style="margin:0 0 15px; color:#6b7280; font-size:13px;">ë¬¸ì˜ì‚¬í•­ì€ ì•„ë˜ ì—°ë½ì²˜ë¡œ ì—°ë½ì£¼ì„¸ìš”</p>
            <p style="margin:0 0 6px; color:#374151; font-size:13px;">ğŸ“ <strong>1844-0239</strong></p>
            <p style="margin:0; color:#374151; font-size:13px;">âœ‰ï¸ <strong>ni5720@daum.net</strong></p>
          </div>
        </div>
        <div style="text-align:center; padding:20px 12px; background:#0F1B2D; border-radius:0 0 16px 16px; color:white;">
          <p style="margin:0 0 6px; font-weight:700; font-size:14px;">K-ìê¸ˆì»´í¼ë‹ˆ</p>
          <p style="margin:0 0 4px; opacity:0.85; font-size:12px;">ì¤‘ì†Œê¸°ì—… ì„±ì¥ì˜ ë“ ë“ í•œ íŒŒíŠ¸ë„ˆ</p>
          <p style="margin:10px 0 0; opacity:0.7; font-size:10px;">â€» ë³¸ ë©”ì¼ì€ ë°œì‹ ì „ìš©ìœ¼ë¡œ íšŒì‹ ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</p>
          <p style="margin:4px 0 0; opacity:0.7; font-size:10px;">ë¬¸ì˜: 1844-0239 | ni5720@daum.net</p>
        </div>
      </div>`;
    }

    function buildStaffEmailHTML(lead) {
      const staffName = document.getElementById('staffName').value || 'ê¹€ì€í¬ ê¸°ì—…ì‹¬ì‚¬ê´€';
      const templateLabels = {
        'receipt': 'ì ‘ìˆ˜í™•ì¸',
        'progress': 'ì§„í–‰ì•ˆë‚´',
        'approval': 'ìŠ¹ì¸ì¶•í•˜',
        'custom': 'ì§ì ‘ì‘ì„±'
      };

      return `
      <div style="font-family:'Pretendard',-apple-system,sans-serif; max-width:600px; margin:0 auto;">
        <div style="background:linear-gradient(135deg,#0F1B2D 0%,#141414 100%); color:white; padding:30px; border-radius:16px 16px 0 0;">
          <h2 style="margin:0; font-size:24px; font-weight:700;">ğŸ“§ ì´ë©”ì¼ ë°œì†¡ ì•Œë¦¼</h2>
          <p style="margin:10px 0 0; opacity:0.95; font-size:14px;">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ ë°œì†¡ë¨ (${templateLabels[currentTemplate]})</p>
        </div>
        <div style="background:white; padding:30px; border:1px solid #e5e7eb; border-top:none;">
          <div style="background:#F5F5F5; padding:20px; border-radius:12px; margin-bottom:25px; border-left:4px solid #1C2D4F;">
            <h3 style="color:#1C2D4F; margin:0 0 15px; font-size:18px;">ğŸ“‹ ë°œì†¡ ëŒ€ìƒ</h3>
            <table style="width:100%;">
              <tr><td style="padding:8px 0; color:#525252; width:40%; white-space:nowrap;">ğŸ‘¤ ì´ë¦„</td><td style="color:#374151;">${e(lead.name)}</td></tr>
              <tr><td style="padding:8px 0; color:#525252; white-space:nowrap;">ğŸ¢ ê¸°ì—…ëª…</td><td style="color:#1C2D4F; font-weight:600;">${e(lead.company)}</td></tr>
              <tr><td style="padding:8px 0; color:#525252; white-space:nowrap;">ğŸ“ ì—°ë½ì²˜</td><td style="color:#374151;">${e(lead.phone)}</td></tr>
              <tr><td style="padding:8px 0; color:#525252; white-space:nowrap;">âœ‰ï¸ ì´ë©”ì¼</td><td style="color:#374151;">${e(lead.email)}</td></tr>
              <tr><td style="padding:8px 0; color:#525252; white-space:nowrap;">ğŸ’° í¬ë§ìê¸ˆ</td><td style="color:#374151;">${e(lead.amount)}</td></tr>
            </table>
          </div>
          <div style="background:#EFF6FF; padding:14px 20px; border-radius:8px; border-left:4px solid #3B82F6;">
            <p style="margin:0; font-size:13px; color:#1E40AF;">ë°œì†¡ì: ${e(staffName)} | í…œí”Œë¦¿: ${templateLabels[currentTemplate]}</p>
          </div>
        </div>
        <div style="text-align:center; padding:20px; background:#0F1B2D; border-radius:0 0 16px 16px; color:white; font-size:12px;">
          <p style="margin:0; font-weight:600;">K-ìê¸ˆì»´í¼ë‹ˆ ê´€ë¦¬ì ì‹œìŠ¤í…œ</p>
          <p style="margin:5px 0 0; opacity:0.9; font-size:11px;">â€» ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ ìë™ ë°œì†¡ëœ ì•Œë¦¼ì…ë‹ˆë‹¤.</p>
        </div>
      </div>`;
    }

    // ========================================
    // Preview
    // ========================================
    function updatePreview() {
      const senderName = document.getElementById('senderName').value || 'K-ìê¸ˆì»´í¼ë‹ˆ';
      const subject = document.getElementById('emailSubject').value;

      // Get first selected lead for preview, or use sample
      let previewLead = null;
      if (selectedIds.size > 0) {
        const firstId = [...selectedIds][0];
        previewLead = allLeads.find(l => l.id === firstId);
      }
      if (!previewLead) {
        previewLead = {
          name: 'í™ê¸¸ë™', company: 'ì˜ˆì‹œê¸°ì—…', phone: '010-1234-5678',
          email: 'example@email.com', amount: '1ì–µ~3ì–µ', callTime: 'ì˜¤ì „ 10ì‹œ~12ì‹œ',
          fundType: 'ì •ì±…ìê¸ˆ', date: new Date().toISOString().split('T')[0]
        };
      }

      // Update meta
      document.getElementById('metaFrom').textContent = `${senderName} <noreply@mail.policy-fund.online>`;
      document.getElementById('metaTo').textContent = previewLead.email || 'ìˆ˜ì‹ ìë¥¼ ì„ íƒí•˜ì„¸ìš”';
      document.getElementById('metaSubject').textContent = substituteVars(subject, previewLead);

      // Build preview HTML
      const previewContainer = document.getElementById('emailPreviewContent');
      if (currentPreviewTab === 'customer') {
        previewContainer.innerHTML = buildPreviewHTML(previewLead);
      } else {
        previewContainer.innerHTML = buildStaffPreviewHTML(previewLead);
      }
    }

    function buildPreviewHTML(lead) {
      const staffName = document.getElementById('staffName').value || 'ê¹€ì€í¬ ê¸°ì—…ì‹¬ì‚¬ê´€';
      const deadline = document.getElementById('deadline').value;
      const extraMsg = document.getElementById('extraMessage').value;

      if (currentTemplate === 'custom') {
        const customBody = document.getElementById('customBody').value || 'ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...';
        const bodyHtml = highlightVars(substituteVars(customBody, lead).replace(/\n/g, '<br>'));
        return `
          <div class="et-header">
            <div style="font-size:11px; opacity:0.7;">K-FUND COMPANY</div>
            <h2>${highlightVars(substituteVars(document.getElementById('emailSubject').value, lead))}</h2>
            <p>K-ìê¸ˆì»´í¼ë‹ˆ ì •ì±…ìê¸ˆ ì „ë¬¸ìƒë‹´</p>
          </div>
          <div class="et-notice">ğŸ“§ ë³¸ ë©”ì¼ì€ ë°œì‹ ì „ìš©ìœ¼ë¡œ íšŒì‹ ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.<br>ë¬¸ì˜ëŠ” <strong>1844-0239</strong> ë˜ëŠ” <strong>ni5720@daum.net</strong></div>
          <div class="et-body">
            <div style="font-size:13px; color:#404040; line-height:1.8;">${bodyHtml}</div>
            <div class="et-contact">
              <p style="margin-bottom:8px;">ë¬¸ì˜ì‚¬í•­ì€ ì•„ë˜ë¡œ ì—°ë½ì£¼ì„¸ìš”</p>
              <p>ğŸ“ <strong>1844-0239</strong></p>
              <p>âœ‰ï¸ <strong>ni5720@daum.net</strong></p>
            </div>
          </div>
          <div class="et-footer">
            <p class="brand">K-ìê¸ˆì»´í¼ë‹ˆ</p>
            <p style="opacity:0.85; margin-top:4px;">ì¤‘ì†Œê¸°ì—… ì„±ì¥ì˜ ë“ ë“ í•œ íŒŒíŠ¸ë„ˆ</p>
          </div>`;
      }

      const headerTitles = {
        'receipt': 'ë¬´ë£Œì§„ë‹¨ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤',
        'progress': 'ì •ì±…ìê¸ˆ ì‹¬ì‚¬ ì§„í–‰ì•ˆë‚´',
        'approval': 'ì •ì±…ìê¸ˆ ìŠ¹ì¸ì„ ì¶•í•˜í•©ë‹ˆë‹¤!'
      };

      const greetings = {
        'receipt': `ì•ˆë…•í•˜ì„¸ìš”, <strong><span class="var-highlight">${e(lead.name)}</span></strong>ë‹˜! ğŸ‘‹<br><br>ì •ì±…ìê¸ˆ ì‹¬ì‚¬ì‹ ì²­ì´ ì •ìƒì ìœ¼ë¡œ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>ì˜ì—…ì¼ê¸°ì¤€ 24ì‹œê°„ ì´ë‚´ ë‹´ë‹¹ ì „ë¬¸ ì»¨ì„¤í„´íŠ¸ê°€ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`,
        'progress': `ì•ˆë…•í•˜ì„¸ìš”, <strong><span class="var-highlight">${e(lead.name)}</span></strong>ë‹˜!<br><br>ì‹ ì²­í•˜ì‹  ì •ì±…ìê¸ˆ ì‹¬ì‚¬ê°€ í˜„ì¬ <strong>ì§„í–‰ ì¤‘</strong>ì…ë‹ˆë‹¤.<br><br>ë‹´ë‹¹ ì‹¬ì‚¬ê´€ì´ ê²€í†  í›„ ê²°ê³¼ë¥¼ ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`,
        'approval': `ì•ˆë…•í•˜ì„¸ìš”, <strong><span class="var-highlight">${e(lead.name)}</span></strong>ë‹˜! ğŸ‰<br><br>ì¶•í•˜í•©ë‹ˆë‹¤! ì‹ ì²­í•˜ì‹  ì •ì±…ìê¸ˆì´ <strong>ìŠ¹ì¸</strong>ë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ì‹œê³ , ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ë‹´ë‹¹ìì—ê²Œ ì—°ë½ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`
      };

      const ctaMessages = {
        'receipt': `ì˜ì—…ì¼ê¸°ì¤€ <strong>24ì‹œê°„ ì´ë‚´</strong>ì—<br>K-ìê¸ˆì»´í¼ë‹ˆì—ì„œ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`,
        'progress': `ì‹¬ì‚¬ ì§„í–‰ ì¤‘ ì¶”ê°€ ì„œë¥˜ê°€ í•„ìš”í•œ ê²½ìš°<br><strong>ë‹´ë‹¹ìê°€ ë³„ë„ ì•ˆë‚´</strong>ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`,
        'approval': `<strong>ì¶•í•˜í•©ë‹ˆë‹¤!</strong><br>ìì„¸í•œ ë‚´ìš©ì€ ë‹´ë‹¹ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.`
      };

      let deadlineRow = '';
      if (deadline) {
        deadlineRow = `<tr><td>ğŸ“… ë§ˆê°ì¼</td><td><span class="var-highlight">${deadline}</span></td></tr>`;
      }

      let extraSection = '';
      if (extraMsg) {
        extraSection = `
          <div style="background:#F5F5F5; padding:16px; border-radius:8px; margin-bottom:16px; border-left:3px solid #1C2D4F;">
            <p style="font-size:13px; color:#404040; line-height:1.7; margin:0;">${e(extraMsg).replace(/\n/g, '<br>')}</p>
          </div>`;
      }

      return `
        <div class="et-header">
          <div style="font-size:11px; opacity:0.7;">K-FUND COMPANY</div>
          <h2>${headerTitles[currentTemplate]}</h2>
          <p>K-ìê¸ˆì»´í¼ë‹ˆ ì •ì±…ìê¸ˆ ì „ë¬¸ìƒë‹´</p>
        </div>
        <div class="et-notice">ğŸ“§ ë³¸ ë©”ì¼ì€ ë°œì‹ ì „ìš©ìœ¼ë¡œ íšŒì‹ ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.<br>ë¬¸ì˜ëŠ” <strong>1844-0239</strong> ë˜ëŠ” <strong>ni5720@daum.net</strong></div>
        <div class="et-body">
          <div class="et-greeting">
            <p>${greetings[currentTemplate]}</p>
          </div>
          <div class="et-info-box">
            <h4>ğŸ“‹ ì ‘ìˆ˜ ë‚´ìš©</h4>
            <table>
              <tr><td>ğŸ¢ ê¸°ì—…ëª…</td><td><span class="var-highlight">${e(lead.company)}</span></td></tr>
              <tr><td>ğŸ“ ì—°ë½ì²˜</td><td><span class="var-highlight">${e(lead.phone)}</span></td></tr>
              <tr><td>ğŸ’° í¬ë§ìê¸ˆ</td><td><span class="var-highlight">${e(lead.amount)}</span></td></tr>
              <tr><td>â° ì—°ë½ì‹œê°„</td><td><span class="var-highlight">${e(lead.callTime)}</span></td></tr>
              ${deadlineRow}
            </table>
          </div>
          ${extraSection}
          <div class="et-cta"><p>${ctaMessages[currentTemplate]}</p></div>
          <div class="et-contact">
            <p style="margin-bottom:8px;">ë¬¸ì˜ì‚¬í•­ì€ ì•„ë˜ë¡œ ì—°ë½ì£¼ì„¸ìš”</p>
            <p>ğŸ“ <strong>1844-0239</strong></p>
            <p>âœ‰ï¸ <strong>ni5720@daum.net</strong></p>
          </div>
        </div>
        <div class="et-footer">
          <p class="brand">K-ìê¸ˆì»´í¼ë‹ˆ</p>
          <p style="opacity:0.85; margin-top:4px;">ì¤‘ì†Œê¸°ì—… ì„±ì¥ì˜ ë“ ë“ í•œ íŒŒíŠ¸ë„ˆ</p>
          <p style="opacity:0.6; margin-top:8px; font-size:10px;">â€» ë³¸ ë©”ì¼ì€ ë°œì‹ ì „ìš©ìœ¼ë¡œ íšŒì‹ ì´ ë¶ˆê°€í•©ë‹ˆë‹¤.</p>
          <p style="opacity:0.6; margin-top:2px; font-size:10px;">ë¬¸ì˜: 1844-0239 | ni5720@daum.net</p>
        </div>`;
    }

    function buildStaffPreviewHTML(lead) {
      const staffName = document.getElementById('staffName').value || 'ê¹€ì€í¬ ê¸°ì—…ì‹¬ì‚¬ê´€';
      const templateLabels = {
        'receipt': 'ì ‘ìˆ˜í™•ì¸',
        'progress': 'ì§„í–‰ì•ˆë‚´',
        'approval': 'ìŠ¹ì¸ì¶•í•˜',
        'custom': 'ì§ì ‘ì‘ì„±'
      };

      return `
        <div class="et-header">
          <div style="font-size:11px; opacity:0.7;">K-FUND COMPANY</div>
          <h2>ğŸ“§ ì´ë©”ì¼ ë°œì†¡ ì•Œë¦¼</h2>
          <p>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ ë°œì†¡ë¨ (${templateLabels[currentTemplate]})</p>
        </div>
        <div class="et-body">
          <div class="et-greeting">
            <p><strong>ë°œì†¡ ëŒ€ìƒ ì •ë³´</strong></p>
            <p>ğŸ‘¤ ì´ë¦„: <span class="var-highlight">${e(lead.name)}</span></p>
            <p>ğŸ¢ ê¸°ì—…ëª…: <span class="var-highlight">${e(lead.company)}</span></p>
            <p>ğŸ“ ì—°ë½ì²˜: <span class="var-highlight">${e(lead.phone)}</span></p>
            <p>âœ‰ï¸ ì´ë©”ì¼: <span class="var-highlight">${e(lead.email)}</span></p>
            <p>ğŸ’° í¬ë§ìê¸ˆ: <span class="var-highlight">${e(lead.amount)}</span></p>
          </div>
          <div style="background:#EFF6FF; padding:14px; border-radius:8px; border-left:3px solid #3B82F6; margin-bottom:16px;">
            <p style="font-size:13px; color:#1E40AF; margin:0;">ë°œì†¡ì: ${e(staffName)} | í…œí”Œë¦¿: ${templateLabels[currentTemplate]}</p>
          </div>
        </div>
        <div class="et-footer">
          <p class="brand">K-ìê¸ˆì»´í¼ë‹ˆ ê´€ë¦¬ì ì‹œìŠ¤í…œ</p>
          <p style="opacity:0.85; margin-top:4px;">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì—ì„œ ìë™ ë°œì†¡ëœ ì•Œë¦¼</p>
        </div>`;
    }

    function switchPreviewTab(tab) {
      document.querySelectorAll('.preview-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentPreviewTab = tab.dataset.tab;
      updatePreview();
    }

    // ========================================
    // Send Emails
    // ========================================
    async function sendEmails() {
      if (isSending) return;
      if (selectedIds.size === 0) return;

      const selectedLeads = allLeads.filter(l => selectedIds.has(l.id) && l.email && l.email.includes('@'));
      if (selectedLeads.length === 0) {
        showToast('ì´ë©”ì¼ ì£¼ì†Œê°€ ìœ íš¨í•œ ìˆ˜ì‹ ìê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }

      if (!confirm(`${selectedLeads.length}ëª…ì—ê²Œ ì´ë©”ì¼ì„ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      isSending = true;
      const btn = document.getElementById('btnSend');
      btn.disabled = true;
      document.getElementById('btnSendText').textContent = 'ë°œì†¡ ì¤‘...';

      const progressEl = document.getElementById('sendProgress');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const logEl = document.getElementById('sendLog');
      progressEl.classList.add('visible');
      logEl.innerHTML = '';

      let successCount = 0;
      let failCount = 0;
      const senderName = document.getElementById('senderName').value || 'K-ìê¸ˆì»´í¼ë‹ˆ';

      for (let i = 0; i < selectedLeads.length; i++) {
        const lead = selectedLeads[i];
        const pct = Math.round(((i) / selectedLeads.length) * 100);
        progressFill.style.width = pct + '%';
        progressText.textContent = `${i + 1} / ${selectedLeads.length} ê±´ ë°œì†¡ ì¤‘...`;

        try {
          const customerHtml = buildCustomerEmailHTML(lead);
          const staffHtml = buildStaffEmailHTML(lead);
          const subject = substituteVars(document.getElementById('emailSubject').value, lead);

          const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              emailFrom: `${senderName} <noreply@mail.policy-fund.online>`,
              customerEmail: lead.email,
              customerSubject: subject,
              customerHtml: customerHtml,
              staffEmails: ['ni5720@daum.net'],
              staffSubject: `[ì´ë©”ì¼ë°œì†¡] ${lead.company} - ${lead.name}ë‹˜ì—ê²Œ ë°œì†¡ì™„ë£Œ`,
              staffHtml: staffHtml
            })
          });

          const result = await response.json();
          if (response.ok && result.success) {
            successCount++;
            logEl.innerHTML += `<div class="send-log-item success">âœ“ ${e(lead.name)} (${e(lead.email)}) - ë°œì†¡ ì„±ê³µ</div>`;
          } else {
            failCount++;
            logEl.innerHTML += `<div class="send-log-item fail">âœ— ${e(lead.name)} (${e(lead.email)}) - ${result.error || 'ë°œì†¡ ì‹¤íŒ¨'}</div>`;
          }
        } catch (err) {
          failCount++;
          logEl.innerHTML += `<div class="send-log-item fail">âœ— ${e(lead.name)} (${e(lead.email)}) - ${err.message}</div>`;
        }

        // Scroll log to bottom
        logEl.scrollTop = logEl.scrollHeight;

        // Small delay between sends
        if (i < selectedLeads.length - 1) {
          await new Promise(r => setTimeout(r, 500));
        }
      }

      progressFill.style.width = '100%';
      progressText.textContent = `ì™„ë£Œ: ì„±ê³µ ${successCount}ê±´ / ì‹¤íŒ¨ ${failCount}ê±´`;

      isSending = false;
      btn.disabled = false;
      document.getElementById('btnSendText').textContent = `${selectedIds.size}ëª…ì—ê²Œ ë°œì†¡`;

      if (failCount === 0) {
        showToast(`${successCount}ê±´ ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ!`, 'success');
      } else {
        showToast(`ì„±ê³µ ${successCount}ê±´, ì‹¤íŒ¨ ${failCount}ê±´`, failCount > successCount ? 'error' : 'info');
      }
    }

    // ========================================
    // Utility
    // ========================================
    function e(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    const escapeHtml = e;

    // ========================================
    // Init
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      // Set default deadline to 7 days from now
      const d = new Date();
      d.setDate(d.getDate() + 7);
      document.getElementById('deadline').value = d.toISOString().split('T')[0];

      loadLeads();
      updatePreview();
    });
  </script>
</body>
</html>
